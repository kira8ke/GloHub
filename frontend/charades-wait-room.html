<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Charades Wait Room - GloHub</title>
  <style>
    :root{--bg:#120018;--card:#1e0a2a;--accent:#ff66c4;--text:#fff;--muted:rgba(255,255,255,0.8)}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Helvetica,Arial}
    body{background:#8435DE;display:flex;align-items:center;justify-content:center;color:var(--text);padding:20px}
    
    .container{width:100%;max-width:800px;padding:40px;box-sizing:border-box;text-align:center;background:#8435DE;border-radius:20px;border:2px solid var(--accent)}
    
    h1{font-size:40px;margin:0 0 10px 0;background:linear-gradient(135deg,#ff66c4,#ff99dd);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    
    .room-info{color:var(--muted);font-size:14px;margin-bottom:30px}
    
    .game-code{font-size:32px;color:var(--accent);font-weight:700;font-family:monospace;letter-spacing:3px}
    
    .players-section{margin:40px 0;text-align:left}
    
    .players-label{font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:15px}
    
    .players-list{background:rgba(0,0,0,0.3);border-radius:12px;padding:20px;min-height:100px;max-height:300px;overflow-y:auto}
    
    .player-item{display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,102,196,0.1);border-left:3px solid var(--accent);border-radius:8px;margin-bottom:10px;animation:slideIn 300ms ease}
    
    @keyframes slideIn{
      from{opacity:0;transform:translateX(-20px)}
      to{opacity:1;transform:translateX(0)}
    }
    
    .player-avatar{width:40px;height:40px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;color:var(--bg);font-weight:700;font-size:18px}
    
    .player-name{flex:1;font-weight:600;color:var(--text)}
    
    .player-status{font-size:12px;color:var(--muted)}
    
    .empty-state{text-align:center;color:var(--muted);padding:40px 20px}
    
    .empty-state-icon{font-size:48px;margin-bottom:10px}
    
    .waiting-indicator{display:flex;align-items:center;justify-content:center;gap:8px;color:var(--accent);margin:20px 0}
    
    .dot{width:8px;height:8px;border-radius:50%;background:var(--accent);animation:pulse 1.5s ease-in-out infinite}
    
    .dot:nth-child(1){animation-delay:0s}
    .dot:nth-child(2){animation-delay:0.3s}
    .dot:nth-child(3){animation-delay:0.6s}
    
    @keyframes pulse{
      0%,100%{opacity:0.3;transform:scale(1)}
      50%{opacity:1;transform:scale(1.2)}
    }
    
    .admin-controls{background:rgba(255,102,196,0.15);border:2px solid var(--accent);border-radius:12px;padding:20px;margin-top:30px;display:none}
    
    .admin-controls.visible{display:block}
    
    .admin-label{font-size:12px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:15px;font-weight:700}
    
    .super-admin-section{background:rgba(123,44,255,0.15);border:2px solid rgba(199,125,255,0.6);border-radius:12px;padding:20px;margin-top:30px;text-align:center}
    
    .super-admin-badge{display:inline-block;background:linear-gradient(135deg,#7b2cff,#c77dff);color:#fff;padding:8px 16px;border-radius:20px;font-size:12px;font-weight:700;margin-bottom:15px;letter-spacing:0.5px}
    
    .btn-start{background:linear-gradient(135deg,#ff66c4,#ff99dd);color:var(--bg);border:none;padding:15px 40px;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;transition:all 300ms ease;width:100%;text-transform:uppercase;letter-spacing:1px}
    
    .btn-start:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 10px 30px rgba(255,102,196,0.4)}
    
    .btn-start:disabled{opacity:0.5;cursor:not-allowed}
    
    .error{color:#ff6b6b;margin:20px 0;padding:15px;background:rgba(255,107,107,0.1);border-radius:8px}
    
    @media (max-width:600px){
      .container{padding:20px}
      h1{font-size:28px}
      .game-code{font-size:24px}
      .players-list{max-height:200px}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé≠ Charades Game Wait Room</h1>
    <p class="room-info">Game starting soon...</p>
    
    <div class="game-code" id="gameCodeDisplay">LOADING...</div>
    
    <div class="players-section">
      <div class="players-label">Players Ready (<span id="playerCount">0</span>)</div>
      <div class="players-list" id="playersList">
        <div class="empty-state">
          <div class="empty-state-icon">‚è≥</div>
          <p>Waiting for players to join...</p>
        </div>
      </div>
    </div>
    
    <div class="waiting-indicator">
      <span>Waiting for all players</span>
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
    
    <!-- Super Admin Badge & Controls -->
    <div class="super-admin-section" id="superAdminSection" style="display:none; margin-top: 30px;">
      <div class="super-admin-badge">üëë Super Admin Mode</div>
      <p style="font-size: 14px; color: rgba(255, 255, 255, 0.7); margin: 10px 0;">
        You have access to all game pages and controls for testing purposes.
      </p>
      <button class="btn-start" id="skipToGameBtn" style="background: linear-gradient(135deg, #7b2cff, #c77dff); margin-top: 15px;">
        Skip to Charades Game
      </button>
    </div>
    
    <!-- Admin Controls -->
    <div class="admin-controls" id="adminControls">
      <div class="admin-label">Admin Controls</div>
      <button class="btn-start" id="startGameBtn" onclick="startGame()">Start Game Now</button>
    </div>
    
    <div class="error" id="errorMessage" style="display:none;"></div>
  </div>

  <script src="config.js"></script>
  <script type="module">
    // Session validation
    const sessionId = sessionStorage.getItem('sessionId');
    const joinCode = sessionStorage.getItem('joinCode');
    const username = sessionStorage.getItem('username');
    const isSuperAdmin = sessionStorage.getItem('isSuperAdmin') === 'true';

    if (!sessionId || !joinCode || !username) {
      document.getElementById('errorMessage').textContent = 'Session invalid. Redirecting...';
      document.getElementById('errorMessage').style.display = 'block';
      setTimeout(() => window.location.href = 'join-game.html', 2000);
    } else {
      // Display game code
      document.getElementById('gameCodeDisplay').textContent = joinCode;
      
      // Show admin controls & super admin section if super admin
      if (isSuperAdmin) {
        document.getElementById('adminControls').classList.add('visible');
        document.getElementById('superAdminSection').style.display = 'block';
        
        // Add skip to game button handler
        document.getElementById('skipToGameBtn').addEventListener('click', () => {
          window.location.href = 'charades-game.html';
        });
      }
      
      // Load players list
      loadPlayersList();
      
      // Poll for player updates every 2 seconds
      setInterval(loadPlayersList, 2000);
    }

    async function loadPlayersList() {
      try {
        const { data: players, error } = await supabase
          .from('players')
          .select('*')
          .eq('session_id', sessionId)
          .order('joined_at', { ascending: true });

        if (error) {
          console.error('Error loading players:', error);
          return;
        }

        const playersList = document.getElementById('playersList');
        const playerCount = document.getElementById('playerCount');

        if (!players || players.length === 0) {
          playersList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚è≥</div><p>Waiting for players to join...</p></div>';
          playerCount.textContent = '0';
          return;
        }

        playerCount.textContent = players.length;
        playersList.innerHTML = players.map((player, index) => `
          <div class="player-item">
            <div class="player-avatar">${player.username?.charAt(0).toUpperCase() || '?'}</div>
            <div class="player-name">${player.username || 'Unknown Player'}</div>
            <div class="player-status">‚úì Ready</div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Error in loadPlayersList:', err);
      }
    }
  </script>

  <script type="module">
    import { initBackendConnection } from './charades-wait-room.js';

    // Initialize WebSocket connection for real-time updates
    initBackendConnection(sessionStorage.getItem('joinCode'));

    async function startGame() {
      const gameCode = sessionStorage.getItem('joinCode');
      const adminId = sessionStorage.getItem('adminId');
      
      if (!gameCode) {
        alert('Game code not found');
        return;
      }

      const btn = document.getElementById('startGameBtn');
      btn.disabled = true;
      btn.textContent = 'Starting...';
      
      try {
        // Call backend to start game
        const response = await fetch(`${window.BACKEND_URL}/charades/game/${gameCode}/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ admin_id: adminId })
        });

        const data = await response.json();
        if (data.success) {
          // Trigger wheel spin
          const spinResponse = await fetch(`${window.BACKEND_URL}/charades/game/${gameCode}/spin`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ admin_id: adminId })
          });

          if (spinResponse.ok) {
            // Redirect all players to game
            setTimeout(() => {
              window.location.href = 'charades-game.html';
            }, 500);
          }
        } else {
          alert('Error: ' + (data.error || 'Failed to start game'));
          btn.disabled = false;
          btn.textContent = 'Start Game Now';
        }
      } catch (err) {
        console.error('Error starting game:', err);
        btn.disabled = false;
        btn.textContent = 'Start Game Now';
        alert('Error starting game');
      }
    }
  </script>
</body>
</html>
