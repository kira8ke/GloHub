<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="true">
    <meta name="theme-color" content="#ff69b4">
    <title>Admin Login - GloHub</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Blurred background image */
        .auth-page {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        position: relative;
        
        /* Same gradient background as galentines hero */
        background:
            radial-gradient(circle at 20% 30%, #ff4fd8 0%, transparent 40%),
            radial-gradient(circle at 80% 70%, #6c2cff 0%, transparent 45%),
            linear-gradient(135deg, #120018, #2b0036, #3a004d);
        overflow: hidden;
        }

        .auth-page::before {
        content: '';
        position: absolute;
        inset: 0;
        background-image:
            radial-gradient(#ff66c4 1px, transparent 1px),
            radial-gradient(#8f5cff 1px, transparent 1px);
        background-size: 60px 60px, 90px 90px;
        animation: particleMove 20s linear infinite;
        opacity: 0.35;
        pointer-events: none;
        z-index: 0;
        filter: blur(0.5px);
    }

        /* Add overlay for better text readability */
        .auth-page::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        @keyframes particleMove {
    from { background-position: 0 0, 0 0; }
    to { background-position: 500px 300px, -400px -200px; }
}

        /* Enhance auth card to stand out */
        .auth-card {
            background: transparent;
        }

        /* Center the login button */
        .auth-form {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .auth-form .btn-large {
            width: auto;
            min-width: 200px;
        }

        /* Responsive tweaks */
        @media (max-width: 480px) {
            .auth-form input#adminCode { width: calc(100vw - 48px); max-width: 360px; }
            .auth-form .btn-large { min-width: 90%; }
            .auth-logo { font-size: 36px; }
            .auth-card { padding: 20px; }
        }

        /* ===== Cinematic Page Transition ===== */
        #transitionOverlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, #ff4fd8, #120018 70%);
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
            transition: opacity 0.8s ease;
        }

        #transitionOverlay.active {
            opacity: 1;
        }

        .portal-glow {
            position: absolute;
            inset: 0;
            background:
                radial-gradient(circle at center, rgba(255,79,216,0.6), transparent 60%);
            animation: portalPulse 1.2s ease-in-out infinite;
        }

        @keyframes portalPulse {
            0% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.6; }
        }

    </style>
</head>
<body class="auth-page">
    <div class="auth-container">
        <h1 class="auth-logo" style="font-family: 'Brush Script MT', cursive; font-size: 70px; color:white;">Admin login</h1>
        <div class="auth-card">            
            <form id="adminLoginForm" class="auth-form">
                <div class="form-group">
                    <input 
                        type="text" 
                        id="adminCode" 
                        placeholder="Enter your admin code" 
                        required
                        autocomplete="off"
                        style="text-align: center; width: 400px;">
                </div>

                <div class="form-group">
                    <input
                        type="text"
                        id="adminDisplayName"
                        placeholder="What should we call you?"
                        autocomplete="name"
                        style="text-align: center; width: 400px; margin-top: 10px;">
                </div>
                
                <button type="submit" class="btn-large" style=" box-shadow:
                0 0 20px rgba(255, 79, 216, 0.6),
                0 0 40px rgba(123, 44, 255, 0.4);
            animation: floatingGlow 3s ease-in-out infinite;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); background: linear-gradient(135deg, #ff4fd8, #7b2cff);">Login</button>
                
                <div id="errorMessage" class="error-message" style="display: none;"></div>
            </form>
            
            <div class="auth-footer">
                <a href="galentines.html" class="link-primary">Don't have an admin code yet?</a>
            </div>
            
            <a href="galentines.html" class="back-link">Back to Home</a>
        </div>
    </div>

            <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
            <script src="supabase.js"></script>

            <script>
            const form = document.getElementById('adminLoginForm');
            const errorMsg = document.getElementById('errorMessage');

            form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const code = document.getElementById('adminCode').value.trim().toUpperCase();

            try {
                // Discover backend endpoint (try configured BACKEND_URL then common localhost addresses)
                async function findBackend() {
                    const candidates = [];
                    if (window.BACKEND_URL) candidates.push(window.BACKEND_URL.replace(/\/$/, ''));
                    // try host-specific localhost variants
                    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                        candidates.push(`http://${location.hostname}:4000`);
                    }
                    // common local backends
                    candidates.push('http://localhost:4000', 'http://127.0.0.1:4000');

                    for (const c of candidates) {
                        try {
                            const h = await fetch(c + '/health', { method: 'GET', mode: 'cors' });
                            if (h && h.ok) return c;
                        } catch (e) {
                            // ignore
                        }
                    }
                    return '';
                }

                let base = '';
                if (window.BACKEND_URL) base = window.BACKEND_URL.replace(/\/$/, '');
                if (!base) base = await findBackend();

                if (!base) {
                    throw new Error('Cannot reach backend. Start the backend (cd backend && npm start) or set window.BACKEND_URL to your backend URL.');
                }

                const resp = await fetch(base + '/auth/verify-admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });

                if (resp.status === 405) {
                    const text = await resp.text().catch(() => '');
                    throw new Error(`405 Method Not Allowed. Likely the request reached a static server (Live Server). Ensure your backend is running at ${base} and accessible, or set window.BACKEND_URL to your backend URL. Server responded: ${text}`);
                }

                if (!resp.ok) {
                    const text = await resp.text().catch(() => '');
                    throw new Error(`Server error: ${resp.status} ${text}`);
                }

                let result;
                try {
                    result = await resp.json();
                } catch (e) {
                    throw new Error('Invalid server response');
                }

                if (result && result.success) {
                    if (result.role === 'super') {
                        persistSession({
                            role: 'super',
                            id: result.id,
                            name: result.name || 'Super Admin',
                            code: result.code
                        });

                        // Save optional admin display name (from login form) into sessionStorage
                        const displayName = document.getElementById('adminDisplayName')?.value.trim() || '';
                        if (displayName) {
                            sessionStorage.setItem('adminDisplayName', displayName);
                            try { localStorage.setItem('adminDisplayName', displayName); } catch (e) {}
                        }

                        // Redirect to intro page (preserve existing role logic)
                        transitionTo('avatar-select.html');
                        return;
                    }

                    if (result.role === 'client') {
                        persistSession({
                            role: 'client',
                            id: result.id,
                            email: result.email,
                            code: result.code
                        });

                        // Save optional admin display name (from login form) into sessionStorage
                        const displayName = document.getElementById('adminDisplayName')?.value.trim() || '';
                        if (displayName) {
                            sessionStorage.setItem('adminDisplayName', displayName);
                            try { localStorage.setItem('adminDisplayName', displayName); } catch (e) {}
                        }

                        // Redirect to intro page (preserve existing role logic)
                        transitionTo('avatar-select.html');
                        return;
                    }
                }

                throw new Error('Invalid admin code');

            } catch (err) {
                console.error('Login error:', err);
                showError(err.message || 'Login failed');
            }
            });

            function persistSession(payload) {
            Object.entries(payload).forEach(([key, value]) => {
                sessionStorage.setItem(key, value);
                try {
                localStorage.setItem(key, value);
                } catch {}
            });
            }

            function transitionTo(url) {
            const overlay = document.getElementById('transitionOverlay');
            overlay.classList.add('active');

            setTimeout(() => {
                window.location.href = url;
            }, 900);
        }

            </script>

        <div id="transitionOverlay">
    <div class="portal-glow"></div>
</div>

</body>
</html>